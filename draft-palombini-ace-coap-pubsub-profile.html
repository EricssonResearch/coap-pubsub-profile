<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>CoAP Pub-Sub Profile for Authentication and Authorization for Constrained Environments (ACE)</title>

  
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 525px);
    width: 300px;
    z-index: 1;
  }
  #rfc\.toc {
    top: 15px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-right: 350px;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 25px auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>


  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Terminology">
<link href="#rfc.section.2" rel="Chapter" title="2 Overview">
<link href="#rfc.section.3" rel="Chapter" title="3 Publisher Profile">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Retrieval of COSE Key for protection of content">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 AS1, AS2 Information">
<link href="#rfc.section.4" rel="Chapter" title="4 Subscriber Profile">
<link href="#rfc.section.5" rel="Chapter" title="5 Pub-Sub Protected Communication">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Using COSE Objects to protect the resource representation">
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations">
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations">
<link href="#rfc.section.8" rel="Chapter" title="8 Acknowledgments">
<link href="#rfc.references" rel="Chapter" title="9 References">
<link href="#rfc.references.1" rel="Chapter" title="9.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="9.2 Informative References">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.8.2 - https://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Palombini, F." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-palombini-ace-coap-pubsub-profile-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2017-9-28" />
  <meta name="dct.abstract" content="This specification defines a profile for authentication and authorization for publishers and subscribers in a pub-sub setting scenario in a constrained environment, using the ACE framework. This profile relies on transport layer or application layer security to authorize the publisher to the broker. Moreover, it relies on application layer security for publisher-broker and subscriber-broker communication." />
  <meta name="description" content="This specification defines a profile for authentication and authorization for publishers and subscribers in a pub-sub setting scenario in a constrained environment, using the ACE framework. This profile relies on transport layer or application layer security to authorize the publisher to the broker. Moreover, it relies on application layer security for publisher-broker and subscriber-broker communication." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">ACE Working Group</td>
<td class="right">F. Palombini</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Ericsson</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">September 28, 2017</td>
</tr>
<tr>
<td class="left">Expires: April 1, 2018</td>
<td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">CoAP Pub-Sub Profile for Authentication and Authorization for Constrained Environments (ACE)<br />
  <span class="filename">draft-palombini-ace-coap-pubsub-profile-latest</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This specification defines a profile for authentication and authorization for publishers and subscribers in a pub-sub setting scenario in a constrained environment, using the ACE framework. This profile relies on transport layer or application layer security to authorize the publisher to the broker. Moreover, it relies on application layer security for publisher-broker and subscriber-broker communication.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of This Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at https://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on April 1, 2018.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2017 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (https://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Terminology</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Overview</a>
</li>
<li>3.   <a href="#rfc.section.3">Publisher Profile</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Retrieval of COSE Key for protection of content</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">AS1, AS2 Information</a>
</li>
</ul><li>4.   <a href="#rfc.section.4">Subscriber Profile</a>
</li>
<li>5.   <a href="#rfc.section.5">Pub-Sub Protected Communication</a>
</li>
<ul><li>5.1.   <a href="#rfc.section.5.1">Using COSE Objects to protect the resource representation</a>
</li>
</ul><li>6.   <a href="#rfc.section.6">Security Considerations</a>
</li>
<li>7.   <a href="#rfc.section.7">IANA Considerations</a>
</li>
<li>8.   <a href="#rfc.section.8">Acknowledgments</a>
</li>
<li>9.   <a href="#rfc.references">References</a>
</li>
<ul><li>9.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>9.2.   <a href="#rfc.references.2">Informative References</a>
</li>
</ul><li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">This specification defines a way to authorize nodes in a CoAP pub-sub type of setting, using the ACE framework <a href="#I-D.ietf-ace-oauth-authz" class="xref">[I-D.ietf-ace-oauth-authz]</a>. The pub-sub scenario is described in <a href="#I-D.ietf-core-coap-pubsub" class="xref">[I-D.ietf-core-coap-pubsub]</a>.</p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#terminology" id="terminology">Terminology</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;REQUIRED&#8221;, &#8220;SHALL&#8221;, &#8220;SHALL NOT&#8221;, &#8220;SHOULD&#8221;, &#8220;SHOULD NOT&#8221;, &#8220;RECOMMENDED&#8221;, &#8220;MAY&#8221;, and &#8220;OPTIONAL&#8221; in this document are to be interpreted as described in RFC 2119 <a href="#RFC2119" class="xref">[RFC2119]</a>.</p>
<p id="rfc.section.1.1.p.2">Readers are expected to be familiar with the terms and concepts described in <a href="#I-D.ietf-ace-oauth-authz" class="xref">[I-D.ietf-ace-oauth-authz]</a> and <a href="#I-D.ietf-core-coap-pubsub" class="xref">[I-D.ietf-core-coap-pubsub]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#overview" id="overview">Overview</a>
</h1>
<p id="rfc.section.2.p.1">The objective of this specification is to specify how to protect a CoAP pub-sub communication, as described in <a href="#I-D.ietf-core-coap-pubsub" class="xref">[I-D.ietf-core-coap-pubsub]</a>, using Ace framework (<a href="#I-D.ietf-ace-oauth-authz" class="xref">[I-D.ietf-ace-oauth-authz]</a>) and profiles (<a href="#I-D.gerdes-ace-dtls-authorize" class="xref">[I-D.gerdes-ace-dtls-authorize]</a>, <a href="#I-D.seitz-ace-oscoap-profile" class="xref">[I-D.seitz-ace-oscoap-profile]</a>).</p>
<p id="rfc.section.2.p.2">The architecture of the scenario is shown in <a href="#archi" class="xref">Figure 1</a>.</p>
<div id="rfc.figure.1"></div>
<div id="archi"></div>
<pre>
             +----------------+   +----------------+
             |                |   |                |
             | Authorization  |   | Authorization  |
             |    Server 1    |   |    Server 2    |
             |                |   |                |
             +----------------+   +----------------+
                      ^                  ^  ^
                      |                  |  |
     +---------(A)----+                  |  +-----(E)------+
     |   +--------------------(B)--------+                 |
     v   v                                                 v     
+------------+             +------------+              +------------+  
|   CoAP     | ----(C)---&gt; |   CoAP     |              |    CoAP    | 
|  Client -  | [&lt;--(D)--&gt;] |  Server -  |              |  Client -  |
|            | ----(F)---&gt; |            |              |            |  
| Publisher  |             |   Broker   | &lt;----(G)---- | Subscriber | 
|            |             |            | -----(H)---&gt; |            |
+------------+             +------------+              +------------+
</pre>
<p class="figure">Figure 1: Architecture CoAP pubsub with Authorization Servers</p>
<p id="rfc.section.2.p.3">The RS is the broker, which contains the topic.  The AS1 hosts the policies about the Broker: what endpoints are allowed to Publish on the Broker.  The AS2 hosts the policies about the topic: what endpoints are allowed to access what topic.  There are four phases, the first three can be done in parallel.</p>
<p></p>

<ol>
<li>The Publisher requests publishing access to a broker at the AS1, and communicates with the Broker to set up security.</li>
<li>The Publisher requests access to a specific topic at the AS2</li>
<li>The Subscriber requests access to a specific topic at the AS2.</li>
<li>The Publisher and the Subscriber securely post to and get publications from the Broker.</li>
</ol>
<p id="rfc.section.2.p.5">This scenario requires the setup of 2 different security associations: on the one hand, the Publisher has a security association with the Broker, to protect the communication and securely authorize the Publisher to publish on a topic (Security Association 1). On the other hand, the Publisher has a security association with the Subscriber, to protect the publication content itself (Security Association 2).  The Security Association 1 is set up using AS1, the Security Association 2 is set up using AS2.</p>
<pre>
+------------+             +------------+              +------------+  
|   CoAP     |             |   CoAP     |              |    CoAP    | 
|  Client -  |             |  Server -  |              |  Client -  |
|            |             |            |              |            |  
| Publisher  |             |   Broker   |              | Subscriber | 
+------------+             +------------+              +------------+
      :   :                       :                           :
      :   '------ Security -------'                           :
      :         Association 1                                 :
      '------------------------------- Security --------------'
                                     Association 2
</pre>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#publisher-profile" id="publisher-profile">Publisher Profile</a>
</h1>
<p id="rfc.section.3.p.1">In this section, it is specified how the Publisher requests, obtains and communicates to the Broker the access token, as well as the retrieval of the keying material to protect the publication.</p>
<div id="rfc.figure.2"></div>
<div id="pubsub-1"></div>
<pre>
             +----------------+   +----------------+
             |                |   |                |
             | Authorization  |   | Authorization  |
             |    Server 1    |   |    Server 2    |
             |                |   |                |
             +----------------+   +----------------+
                      ^                  ^
                      |                  |
     +---------(A)----+                  | 
     |   +--------------------(B)--------+ 
     v   v                                                       
+------------+             +------------+ 
|   CoAP     | ----(C)---&gt; |   CoAP     | 
|  Client -  | [&lt;--(D)--&gt;] |  Server -  |
|            |             |            |
| Publisher  |             |   Broker   |
|            |             |            |
+------------+             +------------+
</pre>
<p class="figure">Figure 2: Phase 1: Publisher side</p>
<p id="rfc.section.3.p.2">This is a combination of two independent phases:</p>
<p></p>

<ul>
<li>one is the establishment of a secure connection between Publisher and Broker, using an ACE profile such as DTLS <a href="#I-D.gerdes-ace-dtls-authorize" class="xref">[I-D.gerdes-ace-dtls-authorize]</a> or OSCOAP <a href="#I-D.seitz-ace-oscoap-profile" class="xref">[I-D.seitz-ace-oscoap-profile]</a>. (A)(C)(D)</li>
<li>the other is the Publisher&#8217;s retrieval of keying material to protect the publication. (B)</li>
</ul>
<p id="rfc.section.3.p.4">In detail:</p>
<p id="rfc.section.3.p.5">(A) corresponds to the Access Token Request and Response between Publisher and Authorization Server to retrieve the Access Token and RS (Broker) Information.  As specified, the Publisher has the role of a CoAP client, the Broker has the role of the CoAP server.</p>
<p id="rfc.section.3.p.6">(C) corresponds to the exchange between Publisher and Broker, where the Publisher sends its access token to the Broker.</p>
<p id="rfc.section.3.p.7">(D) corresponds to the exchange where the Publisher establishes a secure connection with the Broker. Depending on the Information received in (A), this can be for example DTLS handshake, or other protocols such as EDHOC. Depending on the application, there may not be the need for this set up phase: for example, if OSCOAP is used directly and not without EDHOC first.</p>
<p id="rfc.section.3.p.8">(A), (C) and (D) details are specified in the profile used.</p>
<p id="rfc.section.3.p.9">(B) corresponds to the retrieval of the keying material to protect the publication. The detailed message flow is defined below.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#retr-cosekey" id="retr-cosekey">Retrieval of COSE Key for protection of content</a>
</h1>
<p id="rfc.section.3.1.p.1">This phase is common to both Publisher and Subscriber. To maintain the generality, the Publisher or Subscriber is referred as Client in this section.</p>
<div id="rfc.figure.3"></div>
<div id="B"></div>
<pre>
   Client                            Broker             AS2
      | [----- Resource Request ----&gt;] |                 |
      |                                |                 |
      | [&lt;-- AS1, AS2 Information ---] |                 |
      |                                                  |
      | ------- Topic Keying Material Request ---------&gt; |
      |                                                  |
      | &lt;------------ Keying Material ------------------ |
      |                                                  |
</pre>
<p class="figure">Figure 3: B: Access request - response</p>
<p id="rfc.section.3.1.p.2">Complementary to what is defined in the DTLS profile (section 2.), to determine the AS2 in charge of a topic hosted at the broker, the Broker MAY send the address of both the AS in charge of the topic back to the Client, as a response to a Resource Request (Section 2.1).  Analogously to the DTLS profile, instead of the initial Unauthorized Resource Request message, the Client MAY look up the desired topic in a resource directory (see <a href="#I-D.ietf-core-resource-directory" class="xref">[I-D.ietf-core-resource-directory]</a>).</p>
<p id="rfc.section.3.1.p.3">After retrieving the AS2 address, the Client sends a Topic Keying Material Request, which is a token-less authorization as described in <a href="#I-D.seitz-ace-oauth-authz" class="xref">[I-D.seitz-ace-oauth-authz]</a>, section 6.5. More specifically, the Client sends a POST request to the /token endpoint on AS2, that MUST contain in the payload:</p>
<p></p>

<ul>
<li>the grant type set to &#8220;client_credentials&#8221;,</li>
<li>the audience parameter set to the Broker,</li>
<li>the scope parameter set to the topic,</li>
<li>the cnf parameter containing the Client&#8217;s COSE key, if the Client is a publisher, and</li>
<li>OPTIONALLY, other additional parameters such as the client id or the algorithm.</li>
</ul>
<p id="rfc.section.3.1.p.5">Note that, if present, the algorithm MUST be a Content Encryption Algorithm, as defined in Section 10 of <a href="#RFC8152" class="xref">[RFC8152]</a>.  An example of the payload of a Topic Keying Material Request for a Publisher is specified in <a href="#fig-post-as2" class="xref">Figure 4</a>.</p>
<div id="rfc.figure.4"></div>
<div id="fig-post-as2"></div>
<pre>
{
  "grant_type" : "client_credentials",
  "aud" : "Broker1",
  "scope" : "Temp",
  "client_id" : "publisher1",
  "cnf" : 
    { / COSE_Key /
      / type / 1 : 2, / EC2 /
      / kid / 2 : h'11',
      / alg / 3 : -7, / ECDSA with SHA-256 /
      / crv / -1 : 1 , / P-256 /
      / x / -2 : h'65eda5a12577c2bae829437fe338701a10aaa375e1bb5b5de1
      08de439c08551d', 
      / y /-3 : h'1e52ed75701163f7f9e40ddf9f341b3dc9ba860af7e0ca7ca7e
      9eecd0084d19c' 
    }
}
</pre>
<p class="figure">Figure 4: Example of Topic Keying Material Request payload for a Publisher</p>
<p id="rfc.section.3.1.p.6">The AS2 verifies that the Client is authorized to access the topic and, if the &#8220;cnf&#8221; parameter is present, stores the public key of the Client.</p>
<p id="rfc.section.3.1.p.7">The AS2 response contains an empty token and the keying material to protect the publication (&#8220;key&#8221; field in the payload). Moreover, the payload MUST contain the &#8220;profile&#8221; parameter, set to value &#8220;publisher&#8221;, and the &#8220;token_type&#8221; set to &#8220;none&#8221;.</p>
<p id="rfc.section.3.1.p.8">TODO: define &#8220;key&#8221; parameter following ACE framework</p>
<p id="rfc.section.3.1.p.9">The &#8220;key&#8221; parameter value MUST be a serialized COSE Key (see Section 7 of <a href="#RFC8152" class="xref">[RFC8152]</a>), with the following values:</p>
<p></p>

<ul>
<li>kty with value 4 (symmetric)</li>
<li>alg with value defined by the AS2 (Content Encryption Algorithm)</li>
<li>k with value the symmetric key value</li>
<li>OPTIONALLY, kid with an identifier for the key value</li>
</ul>
<p id="rfc.section.3.1.p.11">An example for the response is detailed in <a href="#fig-resp-as2" class="xref">Figure 5</a>.</p>
<div id="rfc.figure.5"></div>
<div id="fig-resp-as2"></div>
<pre>
{
  "access_token" : NULL,
  "token_type" : "none",
  "profile" : "publisher",
  "key" : h'a4010402421234030c205002e2cc3a9b92855220f255fff1c615bc'
 /{1: 4, 2: h'1234', 3: 12, -1: h'02e2cc3a9b92855220f255fff1c615bc'}/
}
</pre>
<p class="figure">Figure 5: Example of Topic Keying Material response payload for a Publisher</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#as1-as2-information" id="as1-as2-information">AS1, AS2 Information</a>
</h1>
<p id="rfc.section.3.2.p.1">The Client MUST be able to process the following response message from the Broker, in order to retrieve the correct AS1 and AS2 addresses.</p>
<p id="rfc.section.3.2.p.2">This CoAP message MUST have the following characteristics: the CoAP Code MUST be 4.01 &#8220;Unauthorized&#8221;, the payload MUST be present and MUST include the full URI of both AS. An example using CBOR diagnostic notation is given below:</p>
<div id="rfc.figure.6"></div>
<div id="AS-info-ex"></div>
<pre>
    4.01 Unauthorized
    Content-Format: application/ace+cbor
    {"AS1": "coaps://as1.example.com/token",
     "AS2": "coaps://as2.example.com/pubsubkey"}
</pre>
<p class="figure">Figure 6: AS1, AS2 Information example</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#subscriber-profile" id="subscriber-profile">Subscriber Profile</a>
</h1>
<p id="rfc.section.4.p.1">In this section, it is specified how the Subscriber retrieves the keying material to protect the publication.</p>
<div id="rfc.figure.7"></div>
<div id="pubsub-2"></div>
<pre>
                                  +----------------+
                                  |                |
                                  | Authorization  |
                                  |    Server 2    |
                                  |                |
                                  +----------------+
                                            ^
                                            |
                                            +-----(E)------+
                                                           |
                                                           v     
                                                       +------------+  
                                                       |    CoAP    | 
                                                       |  Client -  |
                                                       |            |  
                                                       | Subscriber | 
                                                       |            |
                                                       +------------+
</pre>
<p class="figure">Figure 7: Phase 2: Subscriber side</p>
<p id="rfc.section.4.p.2">Step (E) between Subscriber and AS2 corresponds to the retrieval of the keying material to verify the publication, and is the same as (B) between Publisher and AS2 (<a href="#retr-cosekey" class="xref">Section 3.1</a>), with the following differences:</p>
<p></p>

<ul>
<li>The POST request to the /token endpoint on AS2, does not contain the cnf parameter containing the Client&#8217;s COSE key.</li>
<li>The AS2 response contains a &#8220;cnf&#8221; parameter whose value is set to a COSE Key Set, (Section 7 of <a href="#RFC8152" class="xref">[RFC8152]</a>) i.e. an array of COSE Keys, which contains the public keys of all authorized Publishers, and the &#8220;profile&#8221; parameter is set to value &#8220;subscriber&#8221;</li>
</ul>
<p id="rfc.section.4.p.4">An example of the payload of a Topic Keying Material Request and corresponding response for a Subscriber is specified in <a href="#fig-post2-as2" class="xref">Figure 8</a> and <a href="#fig-resp2-as2" class="xref">Figure 9</a>.</p>
<div id="rfc.figure.8"></div>
<div id="fig-post2-as2"></div>
<pre>
{
  "grant_type" : "client_credentials",
  "aud" : "Broker1",
  "scope" : "Temp",
  "client_id" : "subscriber1"
}
</pre>
<p class="figure">Figure 8: Example of Topic Keying Material Request payload for a Subscriber</p>
<div id="rfc.figure.9"></div>
<div id="fig-resp2-as2"></div>
<pre>
{
  "access_token" : NULL,
  "token_type" : "none",
  "profile" : "subscriber",
  "key" : h'a4010402421234030c205002e2cc3a9b92855220f255fff1c615bc',
 /{1: 4, 2: h'1234', 3: 12, -1: h'02e2cc3a9b92855220f255fff1c615bc'}/
  "cnf" : [
   {
      1 : 2, / type EC2 /
      2 : h'11', / kid /
      3 : -7, / alg ECDSA with SHA-256 /
      -1 : 1 , / crv P-256 /
      -2 : h'65eda5a12577c2bae829437fe338701a10aaa375e1bb5b5de108de43
      9c08551d', / x /
      -3 : h'1e52ed75701163f7f9e40ddf9f341b3dc9ba860af7e0ca7ca7e9eecd
      0084d19c' / y /
    }
  ]
}
</pre>
<p class="figure">Figure 9: Example of Topic Keying Material response payload for a Subscriber</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#pub-sub-protected-communication" id="pub-sub-protected-communication">Pub-Sub Protected Communication</a>
</h1>
<p id="rfc.section.5.p.1">This section specifies the communication Publisher-Broker and Subscriber-Broker, after the previous phases have taken place.</p>
<div id="rfc.figure.10"></div>
<div id="pubsub-3"></div>
<pre>
+------------+             +------------+              +------------+  
|   CoAP     |             |   CoAP     |              |    CoAP    | 
|  Client -  |             |  Server -  |              |  Client -  |
|            | ----(F)---&gt; |            |              |            |  
| Publisher  |             |   Broker   | &lt;----(G)---- | Subscriber | 
|            |             |            | -----(H)---&gt; |            |
+------------+             +------------+              +------------+
</pre>
<p class="figure">Figure 10: Phase 3: Secure communication between Publisher and Subscriber</p>
<p id="rfc.section.5.p.2">The (F) message corresponds to the publication of a topic on the Broker.  The publication (the resource representation) is protected with COSE (<a href="#RFC8152" class="xref">[RFC8152]</a>).  The (G) message is the subscription of the Subscriber, which is unprotected.  The (H) message is the response from the Broker, where the publication is protected with COSE.</p>
<p id="rfc.section.5.p.3">The flow graph is presented below.</p>
<div id="rfc.figure.11"></div>
<div id="E-F-G-ex"></div>
<pre>
  Publisher                Broker               Subscriber
      | --- PUT /topic ----&gt; |                       |
      |  protected with COSE |                       |
      |                      | &lt;--- GET /topic ----- |
      |                      |                       |
      |                      | ---- response ------&gt; |
      |                      |  protected with COSE  |
</pre>
<p class="figure">Figure 11: (F), (G), (H): Example of protected communication</p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#using-cose-objects-to-protect-the-resource-representation" id="using-cose-objects-to-protect-the-resource-representation">Using COSE Objects to protect the resource representation</a>
</h1>
<p id="rfc.section.5.1.p.1">The Publisher uses the symmetric COSE Key received from AS2 in exchange B (<a href="#retr-cosekey" class="xref">Section 3.1</a>) to protect the payload of the PUBLISH operation (Section 4.3 of <a href="#I-D.ietf-core-coap-pubsub" class="xref">[I-D.ietf-core-coap-pubsub]</a>). Specifically, the COSE Key is used to create a COSE_Encrypt0 with algorithm specified by AS2. The Publisher uses the private key corresponding to the public key sent to the AS2 in exchange B (<a href="#retr-cosekey" class="xref">Section 3.1</a>) to countersign the COSE Object as specified in Section 4.5 of <a href="#RFC8152" class="xref">[RFC8152]</a>. The CoAP payload is replaced by the COSE object before the publication is sent to the Broker.</p>
<p id="rfc.section.5.1.p.2">The Subscriber uses the kid in the countersignature field in the COSE object to retrieve the right public key to verify the countersignature. It then uses the symmetric key received from AS2 to verify and decrypt the publication received in the payload of the CoAP Notification from the Broker.</p>
<p id="rfc.section.5.1.p.3">The COSE object is constructed in the following way:</p>
<p></p>

<ul>
<li>The protected Headers (as described in Section 3 of <a href="#RFC8152" class="xref">[RFC8152]</a>) MAY contain the kid parameter, with value the kid of the symmetric COSE Key received in <a href="#retr-cosekey" class="xref">Section 3.1</a> and MUST contain the content encryption algorithm</li>
<li>The unprotected Headers MUST contain the IV and the counter signature that includes: <ul>
<li>the algorithm (same value as in the asymmetric COSE Key received in (B)) in the protected header</li>
<li>the kid (same value as the kid of the asymmetric COSE Key received in (B)) in the unprotected header</li>
<li>the signature computed as specified in Section 4.5 of <a href="#RFC8152" class="xref">[RFC8152]</a>
</li>
</ul>
</li>
<li>The ciphertext, computed over the plaintext that MUST contain the CoAP payload.</li>
</ul>
<p id="rfc.section.5.1.p.5">The external_aad, when using AEAD, is an empty string.</p>
<p id="rfc.section.5.1.p.6">An example is given in <a href="#fig-cose-ex" class="xref">Figure 12</a></p>
<div id="rfc.figure.12"></div>
<div id="fig-cose-ex"></div>
<pre>
16(
  [
    / protected / h'a2010c04421234' / {
        \ alg \ 1:12, \ AES-CCM-64-64-128 \
        \ kid \ 4: h'1234'
      } / , 
    / unprotected / {
      / iv / 5:h'89f52f65a1c580',
      / countersign / 7:[
        / protected / h'a10126' / {
          \ alg \ 1:-7
        } / , 
        / unprotected / {
          / kid / 4:h'11'
        }, 
        / signature / SIG / 64 bytes signature /
      ]
    }, 
    / ciphertext / h'8df0a3b62fccff37aa313c8020e971f8aC8d'
  ]
)
</pre>
<p class="figure">Figure 12: Example of COSE Object sent in the payload of a PUBLISH operation</p>
<p id="rfc.section.5.1.p.7">The encryption and decryption operations are described in sections 5.3 and 5.4 of <a href="#RFC8152" class="xref">[RFC8152]</a>.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<p id="rfc.section.6.p.1">In the profile described above, the Publisher and Subscriber use asymmetric crypto, which would make the message exchange quite heavy for small constrained devices. Moreover, all Subscribers must be able to access the public keys of all the Publishers to a specific topic to be able to verify the publications. Such a database could be set up and managed by the same entity having control of the topic, i.e. AS2.</p>
<p id="rfc.section.6.p.2">An application where it is not critical that only authorized Publishers can publish on a topic may decide not to make use of the asymmetric crypto and only use symmetric encryption/MAC to confidentiality and integrity protect the publication, but this is not recommended since, as a result, any authorized Subscribers with access to the Broker may forge unauthorized publications without being detected. In this symmetric case the Subscribers would only need one symmetric key per topic, and would not need to know any information about the Publishers, that can be anonymous to it and the Broker.</p>
<p id="rfc.section.6.p.3">Subscribers can be excluded from future publications through re-keying for a certain topic. This could be set up to happen on a regular basis, for certain applications. How this could be done is out of scope for this work.</p>
<p id="rfc.section.6.p.4">The Broker is only trusted with verifying that the Publisher is authorized to publish, but is not trusted with the publications itself, which it cannot read nor modify. In this setting, caching of publications on the Broker is still allowed.</p>
<p id="rfc.section.6.p.5">TODO: expand on security and Privacy considerations</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a>
</h1>
<p id="rfc.section.7.p.1">TODO: &#8220;key&#8221; parameter, &#8220;publisher&#8221; and &#8220;subscriber&#8221; profile identifiers</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#acknowledgments" id="acknowledgments">Acknowledgments</a>
</h1>
<p id="rfc.section.8.p.1">The author wishes to thank John Mattsson, Ludwig Seitz and G&#246;ran Selander for the useful discussion that helped shape this document.</p>
<h1 id="rfc.references">
<a href="#rfc.references">9.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">9.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.ietf-ace-oauth-authz">[I-D.ietf-ace-oauth-authz]</b></td>
<td class="top">
<a>Seitz, L.</a>, <a>Selander, G.</a>, <a>Wahlstroem, E.</a>, <a>Erdtman, S.</a> and <a>H. Tschofenig</a>, "<a href="https://tools.ietf.org/html/draft-ietf-ace-oauth-authz-07">Authentication and Authorization for Constrained Environments (ACE)</a>", Internet-Draft draft-ietf-ace-oauth-authz-07, August 2017.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-core-coap-pubsub">[I-D.ietf-core-coap-pubsub]</b></td>
<td class="top">
<a>Koster, M.</a>, <a>Keranen, A.</a> and <a>J. Jimenez</a>, "<a href="https://tools.ietf.org/html/draft-ietf-core-coap-pubsub-02">Publish-Subscribe Broker for the Constrained Application Protocol (CoAP)</a>", Internet-Draft draft-ietf-core-coap-pubsub-02, July 2017.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC8152">[RFC8152]</b></td>
<td class="top">
<a>Schaad, J.</a>, "<a href="https://tools.ietf.org/html/rfc8152">CBOR Object Signing and Encryption (COSE)</a>", RFC 8152, DOI 10.17487/RFC8152, July 2017.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">9.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.gerdes-ace-dtls-authorize">[I-D.gerdes-ace-dtls-authorize]</b></td>
<td class="top">
<a>Gerdes, S.</a>, <a>Bergmann, O.</a>, <a>Bormann, C.</a>, <a>Selander, G.</a> and <a>L. Seitz</a>, "<a href="https://tools.ietf.org/html/draft-gerdes-ace-dtls-authorize-01">Datagram Transport Layer Security (DTLS) Profile for Authentication and Authorization for Constrained Environments (ACE)</a>", Internet-Draft draft-gerdes-ace-dtls-authorize-01, March 2017.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-core-resource-directory">[I-D.ietf-core-resource-directory]</b></td>
<td class="top">
<a>Shelby, Z.</a>, <a>Koster, M.</a>, <a>Bormann, C.</a>, <a>Stok, P.</a> and <a>C. Amsuess</a>, "<a href="https://tools.ietf.org/html/draft-ietf-core-resource-directory-11">CoRE Resource Directory</a>", Internet-Draft draft-ietf-core-resource-directory-11, July 2017.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.seitz-ace-oauth-authz">[I-D.seitz-ace-oauth-authz]</b></td>
<td class="top">
<a>Seitz, L.</a>, <a>Selander, G.</a>, <a>Wahlstroem, E.</a>, <a>Erdtman, S.</a> and <a>H. Tschofenig</a>, "<a href="https://tools.ietf.org/html/draft-seitz-ace-oauth-authz-00">Authorization for the Internet of Things using OAuth 2.0</a>", Internet-Draft draft-seitz-ace-oauth-authz-00, October 2015.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.seitz-ace-oscoap-profile">[I-D.seitz-ace-oscoap-profile]</b></td>
<td class="top">
<a>Seitz, L.</a>, <a>Palombini, F.</a> and <a>M. Gunnarsson</a>, "<a href="https://tools.ietf.org/html/draft-seitz-ace-oscoap-profile-04">OSCOAP profile of the Authentication and Authorization for Constrained Environments Framework</a>", Internet-Draft draft-seitz-ace-oscoap-profile-04, July 2017.</td>
</tr>
</tbody></table>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Francesca Palombini</span> 
	  <span class="n hidden">
		<span class="family-name">Palombini</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:francesca.palombini@ericsson.com">francesca.palombini@ericsson.com</a></span>

  </address>
</div>

  <div class="github-fork-ribbon-wrapper"><div class="github-fork-ribbon"><a href="https://github.com/EricssonResearch/coap-pubsub-profile">Fork me on GitHub</a></div></div>
</body>
</html>
